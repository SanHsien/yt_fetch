# YouTube 頻道影片下載工具 - 專案規格書

## 專案簡介

**yt_fetch.py** 是一個自動化的 YouTube 頻道影片下載工具，專為從指定 YouTube 頻道批量下載最新影片而設計。工具採用 Python 開發，支援跨平台使用（Windows、macOS、Linux），提供互動式和命令列兩種執行模式，並具備完整的錯誤處理和自動環境管理功能。

### 核心價值

- **零配置啟動**：自動建立虛擬環境並安裝依賴，無需手動設定
- **智能過濾**：自動過濾非公開影片、Shorts、直播內容，確保只下載合法可存取的 VOD
- **冪等性保證**：重複執行不會重複下載，自動追蹤已下載的影片
- **友善體驗**：提供互動式輸入和詳細的日誌輸出，適合新手和進階用戶

## 目標使用情境

### 主要使用情境

1. **內容創作者備份**
   - 定期備份自己頻道的最新影片
   - 確保內容有本地副本

2. **學習與研究**
   - 下載教育頻道的最新教學影片
   - 離線學習和參考

3. **內容整理**
   - 從特定頻道收集特定主題的影片
   - 建立個人影片庫

4. **自動化下載**
   - 透過命令列參數或環境變數自動執行
   - 整合到自動化腳本或排程任務

### 目標用戶

- **新手用戶**：透過互動式模式，無需學習命令列參數即可使用
- **進階用戶**：透過命令列參數快速執行，支援自動化和腳本整合
- **開發者**：可透過環境變數配置，適合 CI/CD 或自動化流程

## 功能列表

### 必要功能（Core Features）

#### 1. 影片下載核心功能
- ✅ 從 YouTube 頻道下載指定數量的最新影片
- ✅ 支援多種頻道識別方式（@handle、頻道 ID、完整 URL）
- ✅ 自動下載為 MP4 格式
- ✅ 使用 ffmpeg 合併最佳畫質和音質

#### 2. 智能過濾機制
- ✅ 僅下載公開影片（自動過濾私人、未列出、訂閱者專屬、Premium 專屬）
- ✅ 預設排除 Shorts（可選包含）
- ✅ 自動排除直播內容（is_live、is_upcoming、was_live）
- ✅ 支援 YouTube 頻道分頁（Videos/Shorts，不包含 Live）

#### 3. 冪等性與追蹤
- ✅ 自動記錄已下載的影片（使用 yt-dlp archive）
- ✅ 檢查檔案名稱中的影片 ID
- ✅ 重複執行不會重複下載
- ✅ 計算已存在影片數量，只下載還需要的數量

#### 4. 執行模式
- ✅ 互動式模式：直接執行腳本，以問答方式輸入參數
- ✅ 命令列模式：使用參數直接執行，無需互動
- ✅ 環境變數支援：所有參數可透過環境變數設定

#### 5. 自動環境管理
- ✅ 自動建立虛擬環境（.venv）
- ✅ 自動安裝 yt-dlp 和 imageio-ffmpeg
- ✅ 自動檢測並安裝 ffmpeg（使用 imageio-ffmpeg）

### 次要功能（Optional Features）

#### 1. 進階下載控制
- ⭐ 下載速率限制（--ratelimit）
- ⭐ 下載間隔延遲（--sleep），減少被限流
- ⭐ 自訂重試次數（--retries）

#### 2. 認證與限制處理
- ⭐ 從瀏覽器讀取 cookies（--cookies-from-browser）
- ⭐ 使用 cookies 檔案（--cookies）
- ⭐ 處理年齡限制和地區限制的影片

#### 3. 智能提取策略
- ⭐ 根據需新下載數量動態調整提取數量（remaining_count * 5，上限 50）
- ⭐ 多頁面提取和合併（Videos + Shorts）
- ⭐ 自動去重（根據 video_id）

#### 4. 日誌與錯誤處理
- ⭐ 詳細的下載進度日誌
- ⭐ 友善的錯誤提示和安裝指引
- ⭐ 下載結果清單輸出

## 畫面結構與互動說明

### CLI 介面結構

本工具為命令列工具（CLI），無圖形介面，提供兩種互動方式：

#### 1. 互動式模式（Interactive Mode）

**觸發條件**：直接執行 `python yt_fetch.py` 且未提供 `--channel` 參數

**互動流程**：

```
============================================================
YouTube 頻道影片下載工具
============================================================

請輸入要下載的 YouTube 頻道：
格式範例：@channel_handle
也可以輸入完整 URL 或頻道 ID
頻道: @NicolasYoung

請輸入要下載的影片數量（預設：5）：
數量: 10

是否包含 Shorts？(y/n，預設：n)：
包含 Shorts: n

請輸入重試次數（預設：3）：
重試次數: 5
```

**互動特點**：
- 所有參數都有預設值，可直接按 Enter 使用
- 輸入驗證：數量必須 > 0，無效輸入會使用預設值
- 清晰的提示訊息和格式範例

#### 2. 命令列模式（Command Line Mode）

**觸發條件**：提供 `--channel` 參數

**命令格式**：
```bash
python yt_fetch.py --channel "@channel_handle" [其他參數]
```

**參數說明**：

| 參數 | 說明 | 預設值 | 範例 |
|------|------|--------|------|
| `--channel` | 頻道 URL、ID 或 @handle | - | `--channel "@pewdiepie"` |
| `--count` | 下載數量 | 5 | `--count 10` |
| `--include-shorts` | 包含 Shorts | False | `--include-shorts` |
| `--retries` | 重試次數 | 3 | `--retries 5` |
| `--cookies-from-browser` | 從瀏覽器讀取 cookies | - | `--cookies-from-browser chrome` |
| `--cookies` | cookies 檔案路徑 | - | `--cookies cookies.txt` |
| `--ratelimit` | 下載速率限制（MB/s） | 0 | `--ratelimit 5` |
| `--sleep` | 下載間隔（秒） | 0 | `--sleep 2` |

#### 3. 執行過程輸出

**初始化階段**：
```
============================================================
YouTube 頻道影片下載工具
============================================================
資料夾內已有 3 支影片（從 archive 和檔案名稱判斷）
目標下載 10 支，已有 3 支，還需下載 7 支
將從 Videos 頁面獲取影片（不包含 Shorts）
開始處理頻道: https://www.youtube.com/@NicolasYoung/videos?view=0&sort=dd
```

**下載階段**：
```
提取頻道影片清單: https://www.youtube.com/@NicolasYoung/videos?view=0&sort=dd（限制前 35 支以避免限流）...
從 https://www.youtube.com/@NicolasYoung/videos?view=0&sort=dd 獲取到 35 支影片
合併後共找到 35 支不重複影片
找到 35 支影片，開始篩選...
已跳過 2 支非公開影片（僅下載公開影片）
已跳過 1 支直播/預告影片（只下載 VOD）
找到 32 支可下載影片，目標下載 7 支新影片（總目標 10 支，已有 3 支）...

[1/32] 下載 (0/7 新影片, 總計 3/10): 影片標題...
✓ 完成 (1/7 新影片, 總計 4/10): 影片標題 [video_id].mp4
...
已達到目標下載數量 10 支（原有 3 支 + 新下載 7 支），停止下載
```

**完成階段**：
```
============================================================
下載完成
============================================================

實際下載清單（共 7 支）：

1. 標題: 影片標題
   ID: video_id
   路徑: download/影片標題 [video_id].mp4
   時長: 1200 秒
```

### 檔案結構

```
專案根目錄/
├── yt_fetch.py          # 主程式
├── requirements.txt     # Python 依賴清單
├── README.md           # 使用說明文件
├── .venv/              # 虛擬環境（自動建立）
└── download/           # 下載目錄
    ├── .download_archive.txt  # 下載記錄檔案
    └── *.mp4           # 下載的影片檔案
```

## 非功能需求

### 1. 跨平台支援（Cross-Platform）

**需求**：
- 支援 Windows、macOS、Linux 三大作業系統
- 自動處理不同平台的路徑差異（Windows 使用 `\`，Unix 使用 `/`）
- 自動處理不同平台的虛擬環境結構（Windows: `Scripts/`，Unix: `bin/`）

**實作方式**：
- 使用 Python 標準庫 `pathlib` 處理路徑
- 使用 `sys.platform` 判斷平台
- 使用 `subprocess` 執行跨平台命令

### 2. 效能需求（Performance）

**需求**：
- 下載速度：受網路頻寬和 YouTube 限流影響，工具本身不應成為瓶頸
- 記憶體使用：應能處理大量影片清單（數百支）而不會記憶體溢出
- CPU 使用：ffmpeg 合併過程會使用 CPU，但應在合理範圍內

**優化策略**：
- 使用 `playlistend` 限制提取數量，避免一次載入過多影片
- 逐一下載而非批量下載，降低記憶體壓力
- 支援速率限制和延遲策略，減少被限流

### 3. 可靠性（Reliability）

**需求**：
- 網路錯誤時自動重試（可配置重試次數）
- 下載失敗不影響其他影片的下載
- 斷點續傳：透過 archive 檔案記錄，中斷後可繼續

**實作方式**：
- 使用 yt-dlp 的 `retries`、`fragment_retries`、`file_access_retries` 參數
- 每個影片獨立下載，失敗不影響其他
- 使用 `download_archive` 記錄已下載影片

### 4. 可維護性（Maintainability）

**需求**：
- 程式碼結構清晰，函數職責單一
- 完整的錯誤處理和日誌記錄
- 易於擴展新功能

**實作方式**：
- 模組化設計：環境管理、參數解析、下載邏輯分離
- 詳細的日誌輸出，方便除錯
- 使用類型提示（typing）提高程式碼可讀性

### 5. 安全性（Security）

**需求**：
- 不儲存敏感資訊（cookies 由用戶提供）
- 遵守 YouTube 服務條款
- 僅下載公開可存取的內容

**實作方式**：
- Cookies 僅在記憶體中使用，不寫入檔案
- 自動過濾非公開內容
- 在文件和使用說明中強調合法使用

### 6. 使用者體驗（User Experience）

**需求**：
- 友善的錯誤訊息和安裝指引
- 清晰的進度顯示
- 支援互動式和命令列兩種模式

**實作方式**：
- 詳細的錯誤訊息，包含解決方案
- 顯示下載進度（X/Y 新影片，總計 A/B）
- 互動式模式適合新手，命令列模式適合進階用戶

### 7. 相容性（Compatibility）

**需求**：
- Python 3.7+ 相容
- 與最新版本的 yt-dlp 相容
- 支援各種頻道 URL 格式

**實作方式**：
- 使用 Python 標準庫，避免依賴特定版本
- 定期更新 yt-dlp 到最新版本
- 支援多種頻道識別方式（@handle、頻道 ID、完整 URL）

### 8. 可擴展性（Extensibility）

**需求**：
- 易於添加新的過濾條件
- 易於添加新的下載選項
- 易於整合到其他系統

**實作方式**：
- 使用 `match_filter` 函數，易於擴展過濾邏輯
- 參數化設計，易於添加新參數
- 支援環境變數，易於整合到自動化流程

## 技術架構

### 核心技術棧

- **語言**：Python 3.7+
- **主要依賴**：
  - `yt-dlp`：YouTube 影片下載引擎
  - `imageio-ffmpeg`：自動下載 ffmpeg
- **系統工具**：ffmpeg（用於合併影片和音訊）

### 關鍵模組

1. **環境管理模組**（`ensure_venv_and_restart`）
   - 檢查並建立虛擬環境
   - 安裝依賴套件
   - 重新啟動腳本

2. **ffmpeg 管理模組**（`check_ffmpeg`, `install_ffmpeg`）
   - 檢測系統是否有 ffmpeg
   - 自動安裝 ffmpeg（使用 imageio-ffmpeg）
   - 將 ffmpeg 路徑傳遞給 yt-dlp

3. **參數解析模組**（`parse_args`, `prompt_user_input`）
   - 解析命令列參數
   - 互動式輸入處理
   - 環境變數支援

4. **下載核心模組**（`download_videos`）
   - 頻道 URL 正規化
   - 多頁面提取和合併
   - 影片過濾和下載
   - 進度追蹤和結果記錄

5. **過濾模組**（`is_public_video`, `match_filter`）
   - 公開影片檢查
   - Shorts 過濾
   - 直播內容過濾

## 資料流程

### 下載流程圖

```
1. 啟動腳本
   ↓
2. 檢查虛擬環境 → 建立/安裝依賴
   ↓
3. 解析參數（互動式或命令列）
   ↓
4. 檢查已下載影片 → 計算需新下載數量
   ↓
5. 檢查/安裝 ffmpeg
   ↓
6. 構建頻道 URL（根據 include_shorts 決定頁面）
   ↓
7. 提取影片清單（從 Videos/Shorts 頁面）
   ↓
8. 合併和去重
   ↓
9. 過濾（非公開、已下載、直播）
   ↓
10. 逐一下載（使用 watch URL）
    ↓
11. 檢查下載成功（archive、檔案系統）
    ↓
12. 達到目標數量 → 停止
    ↓
13. 輸出結果清單
```

## 限制與注意事項

### 技術限制

1. **YouTube API 限制**
   - 大量提取可能觸發限流
   - 使用 `playlistend` 限制提取數量
   - 支援速率限制和延遲策略

2. **ffmpeg 依賴**
   - 需要 ffmpeg 才能合併最佳畫質
   - 工具會自動安裝，但需要網路連線

3. **頻道分頁限制**
   - YouTube 將頻道分為 Videos/Shorts/Live
   - 工具只從 Videos 和 Shorts 頁面獲取
   - Live 內容會自動過濾

### 使用限制

1. **合法使用**
   - 僅供個人學習與研究使用
   - 需遵守 YouTube 服務條款和著作權法
   - 不支援繞過付費牆

2. **內容限制**
   - 僅下載公開可存取的影片
   - 不支援下載私人、未列出、訂閱者專屬內容
   - 不支援下載直播內容

## 未來擴展方向

### 可能的增強功能

1. **批次處理**
   - 支援一次處理多個頻道
   - 支援頻道清單檔案

2. **進階過濾**
   - 根據標題關鍵字過濾
   - 根據上傳日期過濾
   - 根據影片長度過濾

3. **下載後處理**
   - 自動提取字幕
   - 自動轉換格式
   - 自動整理檔案結構

4. **通知功能**
   - 下載完成通知
   - 新影片提醒

5. **Web 介面**
   - 提供簡單的 Web UI
   - 圖形化進度顯示

## 版本歷史

### v1.0（當前版本）

- 基本下載功能
- 互動式和命令列雙模式
- 自動環境管理
- 智能過濾（公開影片、Shorts、直播）
- 支援 YouTube 頻道分頁（Videos/Shorts）
- Cookies 支援
- 速率限制和延遲策略
- 自動 ffmpeg 安裝

---

**文件版本**：1.0
**最後更新**：2024.12.06
**維護者**：San-Hsien