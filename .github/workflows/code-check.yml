name: 程式碼檢查

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # 允許手動觸發

jobs:
  check:
    strategy:
      fail-fast: false
      matrix:
        include:
          # 只測試關鍵版本以加快執行速度
          # Python 3.7 使用 Ubuntu 20.04（因為 Ubuntu 24.04 不支援）
          - os: ubuntu-20.04
            python-version: '3.7'
          # 測試最新穩定版本
          - os: ubuntu-latest
            python-version: '3.11'
          # 測試最新版本
          - os: ubuntu-latest
            python-version: '3.12'
    
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10
    
    steps:
    - name: 檢出程式碼
      uses: actions/checkout@v4
    
    - name: 設定 Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: 檢查 Python 版本
      run: |
        python --version
        python -c "import sys; assert sys.version_info >= (3, 7), f'需要 Python 3.7+，當前版本: {sys.version}'"
    
    - name: 檢查語法
      run: |
        python -m py_compile yt_fetch.py
        echo "✓ 語法檢查通過"
    
    - name: 檢查檔案結構
      run: |
        test -f yt_fetch.py || (echo "錯誤: 找不到 yt_fetch.py" && exit 1)
        test -f requirements.txt || (echo "錯誤: 找不到 requirements.txt" && exit 1)
        test -f README.md || (echo "錯誤: 找不到 README.md" && exit 1)
        echo "✓ 檔案結構檢查通過"
    
    - name: 驗證 requirements.txt 格式
      run: |
        python3 << 'EOF'
        import re
        import sys
        
        try:
            with open('requirements.txt', 'r', encoding='utf-8') as f:
                lines = [l.strip() for l in f if l.strip() and not l.startswith('#')]
                has_error = False
                for line in lines:
                    # 移除註解和額外選項
                    clean_line = line.split(';')[0].split('[')[0].strip()
                    # 支援標準的 pip 格式：package, package==version, package>=version 等
                    if not re.match(r'^[a-zA-Z0-9_.-]+(?:[><=!]+[0-9.]+(?:\.\w+)?)?$', clean_line):
                        print(f'警告: 可能無效的依賴格式: {line}')
                        has_error = True
                if not has_error:
                    print('✓ requirements.txt 格式檢查通過')
        except Exception as e:
            print(f'錯誤: 無法讀取 requirements.txt: {e}')
            sys.exit(1)
        EOF
        echo "✓ requirements.txt 格式檢查完成"

    - name: 安裝測試與開發工具
      run: |
        python -m pip install --upgrade pip
        python -m pip install pytest black isort flake8

    - name: 執行測試
      run: pytest -q

    - name: 風格檢查 (black)
      run: black --check yt_fetch.py

    - name: 匯入排序檢查 (isort)
      run: isort --check-only yt_fetch.py

    - name: 語法與靜態檢查 (flake8)
      run: flake8 yt_fetch.py

